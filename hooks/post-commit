#!/bin/bash

# Debugging: Log the script execution
echo "Running post-commit hook..." >> /tmp/post-commit.log

# Set the directory containing the JavaScript files (relative to the Git repository root)
JS_DIR="$(git rev-parse --show-toplevel)/scripts"
echo "JS_DIR: $JS_DIR" >> /tmp/post-commit.log

# Path to the encrypter script
ENCRYPTER_SCRIPT="$JS_DIR/encrypter.py"
echo "ENCRYPTER_SCRIPT: $ENCRYPTER_SCRIPT" >> /tmp/post-commit.log

# Directory to store encrypted files
ENCRYPTED_DIR="$JS_DIR/encrypted"
echo "ENCRYPTED_DIR: $ENCRYPTED_DIR" >> /tmp/post-commit.log

# Ensure the encrypted directory exists
mkdir -p "$ENCRYPTED_DIR"

# Find updated JavaScript files in the last commit
UPDATED_JS_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.js$')
echo "UPDATED_JS_FILES: $UPDATED_JS_FILES" >> /tmp/post-commit.log

# Encrypt each updated JavaScript file
for FILE in $UPDATED_JS_FILES; do
    INPUT_FILE="$JS_DIR/$FILE"
    OUTPUT_FILE="$ENCRYPTED_DIR/$(basename "$FILE").encrypted"
    echo "Encrypting $INPUT_FILE to $OUTPUT_FILE" >> /tmp/post-commit.log
    python "$ENCRYPTER_SCRIPT" "$INPUT_FILE" "$OUTPUT_FILE" "your_password"
done